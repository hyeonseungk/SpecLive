---
alwaysApply: true
---
# TRD: UbiLang â€“ Glossary & Policy Management SaaS

## 1. ê¸°ìˆ  ìŠ¤íƒ ìš”ì•½

| ë ˆì´ì–´ | ê¸°ìˆ  | ë¹„ê³  |
| --- | --- | --- |
| **í”„ë¡ íŠ¸ì—”ë“œ** | Next.js (AppÂ Router, **í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ë§Œ**)<br/>TypeScript, TailwindÂ CSS, RadixÂ UIâ€¯/â€¯shadcn | ì„œë²„ ì»´í¬ë„ŒíŠ¸ ë° APIÂ Route ê¸ˆì§€ |
| **ë°±ì—”ë“œ** | Supabase (PostgreSQLâ€¯+â€¯Authâ€¯+â€¯Edgeâ€¯Functionsâ€¯+â€¯Realtimeâ€¯+â€¯Storage) | SupabaseÂ JSâ€¯v2 |
| **ì´ë©”ì¼ ë°œì†¡** | Supabaseâ€¯Edgeâ€¯Functionsâ€¯+â€¯ResendÂ API | DBâ€¯íŠ¸ë¦¬ê±° â†’â€¯Edgeâ€¯Function â†’â€¯Resend |
| **ë°°í¬** | Vercel (í”„ë¡ íŠ¸) / Supabase (ë°±ì—”ë“œ) | SupabaseÂ Projectâ€¯URLâ€¯ë°â€¯anonâ€¯keyÂ í™˜ê²½ë³€ìˆ˜ |
| **ëª¨ë‹ˆí„°ë§** | Vercelâ€¯Analytics, Supabaseâ€¯LogsÂ +Â Logflare, Sentry |  |

---

## 2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
Client (Next.js, í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸)
  â”‚   â–²
  â–¼   â”‚
Supabase PostgREST API â†â†’ Supabase PostgreSQL (RLS ì ìš©)
  â”‚
  â–¼
Edge Function (ì´ë©”ì¼ ì•Œë¦¼)
  â”‚
  â–¼
Resend API
```

---

## 3. ë°ì´í„° ëª¨ë¸ (Supabase ìŠ¤í‚¤ë§ˆ)

> ëª¨ë“  PKëŠ” `id uuid default gen_random_uuid()`
> namingÂ convention: **snake_case**

### 3.1 ì¡°ì§Â·í”„ë¡œì íŠ¸

| í…Œì´ë¸” | ì£¼ìš” ì»¬ëŸ¼ | ì„¤ëª… |
| --- | --- | --- |
| organizations | id, name, created_at | ì¡°ì§ |
| projects | id, organization_id, name, created_at | ì¡°ì§Â 1â€‘NÂ í”„ë¡œì íŠ¸ |
| memberships | id, project_id, user_id, role (`admin`/`member`), receive_emails (bool) | ì•Œë¦¼ í† ê¸€ í¬í•¨ |

### 3.2 GlossaryÂ /Â Policy

| í…Œì´ë¸” | ì£¼ìš” ì»¬ëŸ¼ | ì„¤ëª… |
| --- | --- | --- |
| glossaries | id, project_id, name, definition, author_id, updated_at | ìš©ì–´ ì •ì˜ |
| policies | id, project_id, title, body, category, author_id, updated_at | ì •ì±… |
| policy_links | id, policy_id, url, type (`context`/`general`) | ë‹¤ì¤‘ URL |
| glossary_links | id, glossary_id, url |  |
| ê´€ê³„ ë§¤í•‘ | policy_terms (`policy_id`, `glossary_id`)<br/>glossary_relations (`glossary_id`, `related_id`) | ì •ì±…â€‘ìš©ì–´ / ìš©ì–´â€‘ìš©ì–´ |

### 3.3 ì•Œë¦¼ ë¡œê·¸ (ì˜µì…˜)

| í…Œì´ë¸” | ì£¼ìš” ì»¬ëŸ¼ | ì„¤ëª… |
| --- | --- | --- |
| email_events | id, target_user_id, event_type, resource_id, sent_at | ì „ì†¡ ê¸°ë¡ |

### 3.4 RLS ì •ì±… ìš”ì•½

| í…Œì´ë¸” | ì •ì±… |
| --- | --- |
| memberships | `user_id = auth.uid()` |
| projects, glossaries, policies | ì¡°ì§â€‘ë©¤ë²„ì‹­ ì¡´ì¬ ì‹œ SELECT |
| insert/update/delete | `role = 'admin'` ë˜ëŠ” ì‘ì„±ì ë³¸ì¸ í•­ëª© ìˆ˜ì •ë§Œ |

---

## 4. ì¸ì¦Â·ê¶Œí•œ

- Supabaseâ€¯Authâ€¯(Email)
- ê´€ë¦¬ì ì´ˆëŒ€: `supabase.auth.admin.inviteUserByEmail()`
- ìœ ì € ë©”íƒ€ë°ì´í„°: `default_org`
- í´ë¼ì´ì–¸íŠ¸ ìºì‹± +â€¯DBâ€¯RLSÂ ì´ì¤‘ ë³´í˜¸

---

## 5. ê¸°ëŠ¥ë³„ êµ¬í˜„

| ê¸°ëŠ¥ | êµ¬í˜„ |
| --- | --- |
| ìš©ì–´Â·ì •ì±… CRUD | SupabaseÂ JSâ€¯mutations â†’Â SWRÂ mutate / Realtime |
| ì»¨í…ìŠ¤íŠ¸Â·ì¼ë°˜ ë§í¬ | URLÂ í•„ë“œ + ì™¸ë¶€ ë§í¬ ì»´í¬ë„ŒíŠ¸ |
| ê²€ìƒ‰Â·í•„í„° | í´ë¼ì´ì–¸íŠ¸â€¯Fuse.js +Â PostgRESTÂ `ilike` |
| ì œì•ˆ íë¦„ | `status` (`draft`/`pending`/`approved`) |
| ì•Œë¦¼ í† ê¸€ | `memberships.receive_emails` |
| ì´ë©”ì¼ ë°œì†¡ | PGâ€¯Trigger â†’Â Edgeâ€¯Function â†’Â Resend |
| ì˜¨ë³´ë”© í…œí”Œë¦¿ | `templates_*`Â â†’Â INSERTÂ â€¦Â SELECT |

---

## 5.1 ì „ì—­ ëª¨ë‹¬ ì‹œìŠ¤í…œ (âš ï¸ í•„ìˆ˜ ì¤€ìˆ˜)

### ëª¨ë‹¬ êµ¬ì¡°
- **ErrorModal**: `components/common/error-modal.tsx`
- **SuccessModal**: `components/common/success-modal.tsx`
- **ì „ì—­ ë Œë”ë§**: `app/layout.tsx`ì—ì„œë§Œ ë Œë”ë§

### í•µì‹¬ ê·œì¹™
1. **ì ˆëŒ€ ì¤‘ë³µ ë Œë”ë§ ê¸ˆì§€**: ê° í˜ì´ì§€ì—ì„œ `<ErrorModal />`ì´ë‚˜ `<SuccessModal />`ì„ ì¶”ê°€ë¡œ ë Œë”ë§í•˜ì§€ ë§ ê²ƒ
2. **Store í•¨ìˆ˜ ì‚¬ìš©**: ëª¨ë‹¬ ì œì–´ëŠ” ë°˜ë“œì‹œ store í•¨ìˆ˜ë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰
3. **Import ê·œì¹™**: ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ìì²´ëŠ” importí•˜ì§€ ë§ê³ , store í•¨ìˆ˜ë§Œ import

### ì‚¬ìš© ë°©ë²•
```typescript
// âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•
import { showError, showSimpleError } from '@/lib/error-store'
import { showSuccess } from '@/lib/success-store'

// âŒ ì˜ëª»ëœ ì‚¬ìš©ë²• - ì ˆëŒ€ ê¸ˆì§€
import { ErrorModal } from '@/components/common/error-modal'
// return <div>...<ErrorModal /></div>  // ì´ë ‡ê²Œ í•˜ë©´ ì•ˆë¨
```

### ìœ„ë°˜ ì‹œ ë°œìƒ ë¬¸ì œ
- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜
- ì¤‘ë³µ ëª¨ë‹¬ í‘œì‹œ
- ì„±ëŠ¥ ì €í•˜
- ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë™ì‘

---

## 6. í”„ë¡ íŠ¸ì—”ë“œ í´ë” êµ¬ì¡° ì˜ˆì‹œ

```
/app
 â”œâ”€ layout.tsx
 â”œâ”€ dashboard/
 â”‚   â”œâ”€ page.tsx
 â”‚   â””â”€ [projectId]/
 â”‚        â”œâ”€ glossary/
 â”‚        â””â”€ policy/
 â”œâ”€ components/
 â”‚   â”œâ”€ glossary/
 â”‚   â”œâ”€ policy/
 â”‚   â””â”€ common/
 â”œâ”€ lib/
 â”‚   â”œâ”€ supabase-browser.ts
 â”‚   â””â”€ hooks/
 â””â”€ utils/
```

- **ëª¨ë“  í˜ì´ì§€ ìµœìƒë‹¨ `use client`**
- ë°ì´í„° íŒ¨ì¹­: SupabaseÂ JSÂ +Â SWR
- ìƒíƒœ: Zustand / ReactÂ Context

---

## 7. ì´ë©”ì¼ ì›Œí¬í”Œë¡œ

```mermaid
sequenceDiagram
    participant DB
    participant EdgeFn
    participant Resend
    participant User

    DB->>EdgeFn: INSERT / UPDATE (glossaries, policies)
    EdgeFn->>Resend: POST /emails
    Resend-->>EdgeFn: 202
    EdgeFn-->>DB: insert email_events
    Resend-->>User: ğŸ“©
```

---

## 8. í’ˆì§ˆ & í…ŒìŠ¤íŠ¸

| ë²”ì£¼ | ë„êµ¬ |
| --- | --- |
| ìœ ë‹› | Jest, RTL |
| E2E | Playwright |
| ë§ˆì´ê·¸ë ˆì´ì…˜ | SupabaseÂ CLI `db push` |
| CI/CD | GitHubÂ Actions +Â VercelÂ Preview |
| ì •ì  ë¶„ì„ | ESLint, Prettier, TSÂ strict |

---

## 9. ë³´ì•ˆ & ì»´í”Œë¼ì´ì–¸ìŠ¤

- RLS í•„ìˆ˜
- JWT ë§Œë£Œ 1h, refresh via `supabase-js`
- Storage: publicÂ false
- Secrets: `RESEND_API_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
- ë¡œê·¸ 14ì¼, PII ìµœì†Œí™”

---

## 10. ì˜¤í”ˆ ì´ìŠˆ

| # | ì´ìŠˆ | ë¹„ê³  |
| --- | --- | --- |
| 1 | ë²„ì „ ê´€ë¦¬ | `history_*` í…Œì´ë¸”, softÂ delete |
| 2 | ëŒ€ê·œëª¨ Realtime ë¶€í•˜ | ChannelÂ sharding |
| 3 | SSO | SupabaseÂ EnterpriseÂ SAML |

---

## ë¶€ë¡ A. RLS ì˜ˆì‹œ SQL

```sql
-- SELECT
create policy "Members can select glossaries"
on glossaries for select
using (
  exists (
    select 1
    from memberships m
    where m.project_id = glossaries.project_id
      and m.user_id = auth.uid()
  )
);

-- INSERT / UPDATE / DELETE
create policy "Admins can modify glossaries"
on glossaries for all
using (
  exists (
    select 1
    from memberships m
    where m.project_id = glossaries.project_id
      and m.user_id = auth.uid()
      and m.role = 'admin'
  )
);
```
